sequenceDiagram
    participant C as Client
    participant MM as MultiplayerManager
    participant AN as AsioNetworkClient
    participant ES as EmbeddedServer
    participant LM as LevelManager
    participant CM as CollisionManager

    Note over C,CM: Actual Multiplayer Implementation Flow

    %% Connection Phase - Real Implementation
    C->>MM: initialize(serverAddress, port, 65000)
    MM->>AN: connect(serverAddress, port)
    AN->>ES: TCP Connection
    MM->>AN: sendMessage(CONNECT, senderId=65000)
    ES->>ES: Assign real PlayerID (1001)
    ES->>AN: NetworkMessage(PLAYER_ASSIGN, playerId=1001)
    MM->>MM: Update playerId_ = 1001

    %% Game State Initialization  
    ES->>LM: getCurrentLevel()->getObjects()
    LM->>ES: Return all level objects
    ES->>ES: serializeObject for each object
    ES->>AN: NetworkMessage(GAME_STATE, serialized objects)
    MM->>MM: processGameState - deserialize objects
    MM->>C: addObject for each deserialized object

    Note over C,CM: Active Gameplay Loop - Real Flow

    %% Input Processing - Actual Implementation
    C->>C: input->readInput()
    C->>MM: setPlayerInput(input)
    MM->>MM: serializePlayerInput - create 8-bit input state
    MM->>AN: sendMessage(PLAYER_INPUT, inputBits + sequence#)
    
    %% Server Processing - Real Implementation
    ES->>ES: processPlayerInput - deserialize input bits
    ES->>ES: Apply input to player object
    ES->>CM: detectCollisions(levelObjects)
    CM->>CM: SpatialGrid optimization + AABB detection
    CM->>CM: resolveCollision using visitor pattern
    
    %% Game State Updates - Actual Implementation
    ES->>ES: updateGameState - process all objects
    ES->>ES: Check if objects changed vs deltaState
    ES->>AN: sendGameStateToClients (GAME_STATE_DELTA if minimal changes)
    
    %% Client State Processing
    MM->>MM: handleGameStateMessage
    MM->>MM: processGameStateDelta OR processGameState
    MM->>MM: deserializeObject for each changed object
    MM->>C: updateEntityPosition OR addObject

    %% Client Prediction - Real Implementation  
    C->>C: predictLocalPlayerMovement
    C->>CM: detectPlayerCollisions(objects, player)
    CM->>CM: Local collision detection for responsive feel
    MM->>MM: reconcileWithServerState - compare server vs predicted

    Note over C,CM: Enemy Death Example - Actual Flow

    %% Enemy Interaction - Real Implementation
    C->>C: player->checkAttackHit(enemy)
    C->>C: enemy->takeDamage(damageAmount)
    C->>MM: sendEnemyStateUpdate(enemyId, isDead=true, health=0)
    MM->>AN: NetworkMessage(ENEMY_STATE_UPDATE, enemyId + isDead + health)
    ES->>LM: Find enemy by ID and update state
    ES->>AN: Broadcast enemy state to all clients

    Note over C,CM: Chat System - Real Implementation

    %% Chat - Actual Implementation
    C->>MM: sendChatMessage("Hello!")
    MM->>AN: NetworkMessage(CHAT_MESSAGE, message data)
    ES->>AN: Broadcast to all other clients
    MM->>MM: handleChatMessage
    MM->>C: chatHandler_(senderId, message)

    Note over C,CM: Disconnection - Real Implementation

    %% Disconnection - Actual Implementation
    C->>MM: shutdown()
    MM->>AN: sendMessage(DISCONNECT, playerId)
    MM->>AN: disconnect()
    ES->>LM: Remove player from level
    ES->>AN: Broadcast DISCONNECT to remaining clients
